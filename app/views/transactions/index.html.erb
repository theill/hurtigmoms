<%- @meta = { :title => t('.title'), :description => t('.description') } -%>

<div id="page-header" class="grid_12">
	<h1><%= t('.title') %><span>Endnu ikke bogførte transaktioner</span></h1>
</div>

<div class="grid_12">
	<div id="transactions-filter">
		<%- form_tag request.path, :method => 'get' do -%>
			<fieldset>
				<%= label_tag :search, t('.search') %>
				<%= text_field_tag :search, params[:search] %>
			</fieldset>
			<fieldset>
				<label for="">Dato interval</label>
				<%= select_date @start_date, :prefix => 'start_date', :prompt => true %> - <%= select_date @end_date, :prefix => 'end_date', :prompt => true %>
			</fieldset>
			<fieldset>
				<label for="">Transaktionstype</label>
				<%= select_tag 'transaction_type', options_for_transaction_types(@transaction_type) %>
			</fieldset>
			<fieldset>
				<label for="">&nbsp;</label>
				<%= submit_tag 'Filter' %>
			</fieldset>
		<%- end -%>
		<div class="clear"></div>
	</div>

	<%- if @transactions.any? -%>
		<div class="quick-buttons">
			<!-- <%= link_to 'Tilføj salg', new_fiscal_year_transaction_path(current_user.active_fiscal_year), { :class => 'button show income' } %>
			<%= link_to 'Tilføj køb', new_fiscal_year_transaction_path(current_user.active_fiscal_year), { :class => 'button show expense' } %>
			<%= link_to 'Tilføj betaling', new_fiscal_year_transaction_path(current_user.active_fiscal_year), { :class => 'button show payment' } %> -->
			
			<%= link_to t('.buttons.add'), new_fiscal_year_transaction_path(current_user.active_fiscal_year), { :class => 'button show', :id => 'add-new-transaction' } %>
			<!-- <%= link_to 'Import postings', new_posting_import_path, { :class => 'button' } %> -->
		</div>
		
		<table id="transactions" class="editable-table">
			<thead>
				<tr>
					<th class="created_at"><%= t('transaction.created_at') %></th>
					<th class="attachment_no"><%= t('transaction.attachment_no') %></th>
					<th><%= t('transaction.note') %></th>
					<th><span class="income"><%= t('transaction.amount_in') %></span></th>
					<th><span class="expense"><%= t('transaction.amount_out') %></span></th>
				</tr>
			</thead>
			<tbody>
				<%= render @transactions %>
				<%# render :partial => 'grouped', :collection => @transactions %>
			</tbody>
			<%- if @transactions.total_pages > 1 -%>
			<tfoot>
				<tr>
					<td colspan="5"><%= will_paginate :previous_label => t('pagination.previous'), :next_label => t('pagination.next') %></td>
				</tr>
			</tfoot>
			<%- end -%>
		</table>
	<%- else -%>
		<p>
			De har ingen registrerede posteringer.
		</p>
		
		<div class="quick-buttons">
			<%= link_to 'Tilføj postering', new_fiscal_year_transaction_path(current_user.active_fiscal_year), { :class => 'button show', :id => 'add-new-transaction' } %>
		</div>
		
		<table id="transactions" class="editable-table"></table>
	<%- end -%>
</div>

<%- content_for :js do -%>
	hurtigmoms.transactions = [<%= @transactions.collect { |t| t.id }.join(',') %>];
	
//	$.poll(30000, function(retry) {
//		$.get('<%= ping_fiscal_year_transactions_path(current_user.active_fiscal_year) %>', null, null, "script");
//		retry();
//	});
	
	$("#transactions .transaction.pay td.note").live("mouseover", function() {
		if (!$(this).data("init")) {
			$(this).data("init", true);
			$(this).draggable({
				cancel: 'a.ui-icon',// clicking an icon won't initiate dragging
				revert: 'invalid', // when not dropped, the item will revert back to its initial position
				helper: 'clone',
				cursor: 'move'
			});
		}
	});
	
	$("#transactions .transaction.buy td.note, #transactions .transaction.sell td.note").droppable({
		accept: '#transactions .transaction.pay td.note',
		hoverClass: 'drophover',
		drop: function(ev, ui) {
			var transaction_id = $(this).parent().attr("id").replace(/transaction_/, '');
			var related_transaction_id = ui.draggable.parent().attr("id").replace(/transaction_/, '');
			var url = '<%= fiscal_year_transaction_equalizations_path(current_user.active_fiscal_year, 0) %>'.replace(/\/0\//, '/' + transaction_id + '/');
			$.post(url, { 'equalization[transaction_id]': transaction_id, 'equalization[related_transaction_id]': related_transaction_id }, null, "script");
		}
	});			

<%- end -%>

<!-- <div class="grid_3">
	<div class="sidebar">
		<h3>Hvordan opretter jeg en postering?</h3>
		<div>
			<p>Den nemmeste måde er at sende en mail til bilag@hurtigmoms.dk
			med dit bilag for posteringen. Et sted i mailen kan du benytte
			følgende felter</p>
			<p>
				<code>
					DATE:    [YYYY-MM-DD]<br/ >
					AMOUNT:  [250 DKK]<br />
					ACCOUNT: [Varekøb]<br />
					NOTE:    [Køb af frimærker]<br />
				</code>
			</p>

			<p>
				Systemet forstår også en mere naturlig beskrivelse af dit
				bilag, fx kan du i "Emne" feltet skrive tekster såsom <code>
				"Køb af frimærker til 500DKK"</code> for at oprette en 
				postering der vil registrere et køb af frimærker på 500,-
				inkl. moms.
			</p>

			<p>
				Kan systemet ikke gætte hvordan bilaget skal tolkes, vil den
				blive registreret i systemet på dags dato med emne feltet 
				brugt som "Tekst" på posteringen. Posteringen vil herefter
				være i en "kræver handling" state.
			</p>
		</div>
	</div>
</div> -->